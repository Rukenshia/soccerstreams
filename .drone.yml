workspace:
  base: /go
  path: src/github.com/Rukenshia/soccerstreams

pipeline:
  dependencies:
    image: golang
    commands:
    - go get -v ./...

  test:
    group: qa
    image: golang
    commands:
    - go test ./...

  lint:
    group: qa
    image: golang
    commands:
    - go get github.com/alecthomas/gometalinter
    - gometalinter --install
    - gometalinter --fast ./... || exit 0

  build-agent:
    group: build
    image: golang
    commands:
    - cd cmd/agent
    - GOOS=linux go build
  build-sweeper:
    group: build
    image: golang
    commands:
    - cd cmd/sweeper
    - GOOS=linux go build
  build-web:
    group: build
    image: golang
    commands:
    - go get github.com/revel/cmd/revel
    - cd cmd/web
    - GOOS=linux revel package github.com/Rukenshia/soccerstreams/cmd/web prod

  upload-agent:
    group: upload
    branch: master
    image: appleboy/drone-scp
    source: cmd/agent/agent
    target: "/root/soc-agent/drone_ci_${DRONE_COMMIT_SHA}"
    host: server.in.fkn.space
    secrets:
    - ssh_username
    - ssh_key
  upload-sweeper:
    group: upload
    branch: master
    image: appleboy/drone-scp
    source: cmd/sweeper/sweeper
    target: "/root/soc-sweeper/drone_ci_${DRONE_COMMIT_SHA}"
    host: server.in.fkn.space
    secrets:
    - ssh_username
    - ssh_key
  upload-web:
    group: upload
    branch: master
    image: appleboy/drone-scp
    source: cmd/web/web.tar.gz
    target: "/root/soc-web/drone_ci_${DRONE_COMMIT_SHA}"
    host: server.in.fkn.space
    secrets:
    - ssh_username
    - ssh_key

  run:
    branch: master
    image: appleboy/drone-ssh
    host: server.in.fkn.space
    secrets:
    - ssh_username
    - ssh_key
    script:
    - cd soc-agent
    - killall soc-agent
    - "ls drone_ci_${DRONE_COMMIT_SHA}/"
    - "mv drone_ci_${DRONE_COMMIT_SHA}/agent soc-agent"
    - "rm -r drone_ci_${DRONE_COMMIT_SHA}"
    - "unlink soc-agent.latest.log"
    - "ln -s ./soc-agent.${DRONE_COMMIT_SHA}.log soc-agent.latest.log"
    - ./soc-agent > "./soc-agent.${DRONE_COMMIT_SHA}.log" 2>&1 &
    - cd ../soc-sweeper
    - killall soc-sweeper
    - "mv drone_ci_${DRONE_COMMIT_SHA}/sweeper soc-sweeper"
    - "rm -r drone_ci_${DRONE_COMMIT_SHA}"
    - "unlink soc-sweeper.latest.log"
    - "ln -s ./soc-sweeper.${DRONE_COMMIT_SHA}.log soc-sweeper.latest.log"
    - ./soc-sweeper > "./soc-sweeper.${DRONE_COMMIT_SHA}.log" 2>&1 &
    - cd ../soc-web
    - killall soc-web
    - "mv drone_ci_${DRONE_COMMIT_SHA}/web.tar.gz soc-web.tar.gz"
    - "rm -r drone_ci_${DRONE_COMMIT_SHA}"
    - tar -xzf soc-web.tar.gz
    - ./run.sh > /dev/null 2>&1 &

  notify:
    branch: master
    image: appleboy/drone-telegram
    format: html
    secrets:
    - source: telegram_user
      target: telegram_to
    - source: telegram_token
      target: telegram_token
    when:
      status: [ success, failure ]
    message: |
      {{#success build.status}}
        &#x1F680 build {{repo.name}}#{{build.number}} succeeded.
      {{else}}
        &#x1F534 build {{repo.name}}#{{build.number}} failed.
      {{/success}}
